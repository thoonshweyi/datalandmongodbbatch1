db.backlinestaffs.insertMany([
    {_id:1,name:"Aung Aung",dept:"IT",salary:400000,city:"Yangon"},
    {_id:2,name:"Su Su",dept:"HR",salary:300000,city:"Mandalay"},
    {_id:3,name:"Kyaw Kyaw",dept:"IT",salary:700000,city:"Yangon"},
    {_id:4,name:"Ni Ni",dept:"Fincnce",salary:200000,city:"Pyinoolwin"},
    {_id:5,name:"Tun Tun",dept:"IT",salary:500000,city:"Yangon"},
])

=> $sortByCount shorthand to group, count, sort(dec)

db.backlinestaffs.aggregate([
    {
        $sortByCount: "$dept"
    }
])


db.backlinestaffs.aggregate([
    {
        $sortByCount: "$city"
    }
])

---------------------------------------------------------------------------------------

=> $bucket

db.collection.aggregate([
    {
        $bucket: {
            groupBy:<expression>,
            boundaries:[lowerbound1,lowerbound2], // ***** lst to grt
            output: {}
        }
    }
]);

= exe 1
db.backlinestaffs.aggregate([
    {
        $bucket: {
            groupBy: "$salary",
            boundaries:[0,300000,500000,800000], // ***** lst to grt
            output: {
                count: {$sum:1},
                names: {$push: "$name"}
            }
        }
    }
]);


=exe 2
db.backlinestaffs.aggregate([
    {
        $bucket: {
            groupBy: "$salary",
            boundaries:[0,300000,500000,800000], // ***** lst to grt
            output: {
                count: {$sum:1},
                names: {$push: "$name"},
                avgSalary: {$avg:"$salary"},
                maxSalary: {$max:"$salary"},
                minSalary: {$min:"$salary"},
            }
        }
    }
]);

-------------------------------------------------------------------------------
=>$bucketAuto

=exe 1
db.backlinestaffs.aggregate([
    {
        $bucketAuto: {
            groupBy: "$salary",
            buckets:1,
            output: {
                count: {$sum:1},
                names: {$push: "$name"},
                avgSalary: {$avg:"$salary"},
                maxSalary: {$max:"$salary"},
                minSalary: {$min:"$salary"},
            }
        }
    }
]);

=exe 2
db.backlinestaffs.aggregate([
    {
        $bucketAuto: {
            groupBy: "$salary",
            buckets:2,
            output: {
                count: {$sum:1},
                names: {$push: "$name"},
                avgSalary: {$avg:"$salary"},
                maxSalary: {$max:"$salary"},
                minSalary: {$min:"$salary"},
            }
        }
    }
]);

=exe 3
db.backlinestaffs.aggregate([
    {
        $bucketAuto: {
            groupBy: "$salary",
            buckets:3,
            output: {
                count: {$sum:1},
                names: {$push: "$name"},
                avgSalary: {$avg:"$salary"},
                maxSalary: {$max:"$salary"},
                minSalary: {$min:"$salary"},
            }
        }
    }
]);

=exe 4
db.backlinestaffs.aggregate([
    {
        $bucketAuto: {
            groupBy: "$salary",
            buckets:4,
            output: {
                count: {$sum:1},
                names: {$push: "$name"},
                avgSalary: {$avg:"$salary"},
                maxSalary: {$max:"$salary"},
                minSalary: {$min:"$salary"},
            }
        }
    }
]);
-------------------------------------------------------------------------------------------------------------
= $out

= exe 1 ( write salary buckets to a new collection)

show collections;

db.backlinestaffs.aggregate([
    {
        $bucket: {
            groupBy: "$salary",
            boundaries:[0,300000,500000,800000], // ***** lst to grt
            output: {
                count: {$sum:1},
                names: {$push: "$name"},
                avgSalary: {$avg:"$salary"},
                maxSalary: {$max:"$salary"},
                minSalary: {$min:"$salary"},
            }
        }
    },{
        $out: "frontlinestaffs"
    }
]);

db.frontlinestaffs.find();

frontlinestaffs // output saved as collection


=exe 2 
db.backlinestaffs.find()
db.frontlinestaffs.find();

db.backlinestaffs.insertMany([
    {_id:6,name:"Bo Bo",dept:"IT",salary:300000,city:"Yangon"},
    {_id:7,name:"Yamon",dept:"HR",salary:600000,city:"Mandalay"},
])

db.backlinestaffs.find();
db.frontlinestaffs.find();


db.backlinestaffs.aggregate([
    {
        $bucket: {
            groupBy: "$salary",
            boundaries:[0,300000,500000,800000], // ***** lst to grt
            output: {
                count: {$sum:1},
                names: {$push: "$name"},
                avgSalary: {$avg:"$salary"},
                maxSalary: {$max:"$salary"},
                minSalary: {$min:"$salary"},
            }
        }
    },{
        $out: "frontlinestaffs"
    }
]);

db.frontlinestaffs.find();
-------------------------------------------------------------------------------------------------------------
=> Use MongoDb Views (Read Only, but always current)

show collections
db.system.views.find()

db.createView("middlelinestaffs_view","backlinestaffs",[
    {
        $bucket: {
            groupBy: "$salary",
            boundaries:[0,300000,500000,800000], // ***** lst to grt
            output: {
                count: {$sum:1},
                names: {$push: "$name"},
                avgSalary: {$avg:"$salary"},
                maxSalary: {$max:"$salary"},
                minSalary: {$min:"$salary"},
            }
        }
    }
])

// middlelinestaffs  [view]


show collections
db.system.views.find();

db.middlelinestaffs_view.find();

=> exe 3
db.backlinestaffs.find()

db.backlinestaffs.insertMany([
    {_id:8,name:"Nyi Nyi",dept:"IT",salary:250000,city:"Yangon"},
    {_id:9,name:"Ko Ko",dept:"IT",salary:200000,city:"Mandalay"},
])

db.backlinestaffs.find()

db.frontlinestaffs.find();

db.middlelinestaffs_view.find();

=> DROP 
db.middlelinestaffs.drop();
show collections


=> $facet - Multiple Analytics in one query

db.collections.aggregate([
    {
        $facet:{
            <outputField1>:[<pipeline1>],
            <outputField2>:[<pipeline1>],
        }
    }
]);

=> exe 1
db.backlinestaffs.aggregate([
    {
        $facet:{
            salaryBucket:[
                {
                    $bucketAuto:{
                        groupBy: "$salary",
                        buckets: 3,
                        output: {
                            count: {$sum:1}
                        }
                    }
                }
            ],
            topDepts:[
                {
                    $sortByCount: "$dept"
                }
            ],
            citygroup:[
                {
                    $sortByCount: "$city"
                }
            ],
            cities: [
                {$group:{_id:"$city"}},
                {
                    $project:{
                        _id:0,
                        city: "$_id"
                    }
                }
            ]
        }
    }
])

=>exe 2
db.backlinestaffs.aggregate([
    {
        $facet: {
            // Pipeline1 : Salary anasysis
            "salaryAnalysis":[
                {
                    $bucket:{
                        groupBy: "$salary",
                        boundaries:[0,300000,500000,800000], 
                        output: {
                            count: {$sum:1},
                            avgSalary: {$avg: "$salary"},
                            employees: {$push: "$name"}
                        }
                    }
                }
            ],
            // Pipeline1 : Department Summary
            "departmentStats": [
                {
                    $group:{
                        _id: "$dept",
                        totalEmployees: {$sum:1},
                        avgSalary: {$avg: "$salary"},
                        minSalary: {$min: "$salary"},
                        maxSalary: {$max: "$salary"},
                    }
                },
                {$sort: {avgSalary: -1}} // 1 ASC, -1 DSC
            ],
            // Pipeline3 : City Distribution
            "cityDistribution": [
                {
                    $group:{
                        _id:"$city",
                        count: {$sum:1},
                        totalSalary: {$sum:"$salary"}
                    }
                }
            ],
             // Pipeline3 : Highest paid employees
            "toEarners": [
                {
                    $project:{
                        name:1,
                        dept:1,
                        salary:1,
                        city:1
                    }
                },
                {
                    $sort: {
                        salary: -1
                    }
                },
                {
                    $limit: 2
                }
            ],
        }
    }
])


-------------------------------------------------------------------------------------------------------------

â­ What $bucket Does (Main Idea)

$bucket groups documents into ranges based on a numeric field.

Think of it like:

Putting salaries into salary boxes

Each box has a range

Count how many people fall into that range

And optionally calculate statistics (avg, min, max, etc.)


1ï¸âƒ£ groupBy: "$salary"

You tell MongoDB:

â€œTake the salary value of each staff, and put them into buckets (groups).â€

2ï¸âƒ£ boundaries: [0, 300000, 500000, 800000]

These are the range borders.

It creates buckets like this:

0 â‰¤ salary < 300000

300000 â‰¤ salary < 500000

500000 â‰¤ salary < 800000

âš  Important:

Left side is inclusive (â‰¥)

Right side is exclusive (<)

Example:
299,999 â†’ goes into first bucket
300,000 â†’ goes into second bucket
499,999 â†’ second bucket
500,000 â†’ third bucket
800,000 â†’ âŒ excluded (not < 800000)
--------------------------------------------------------------------------------------------------
1ï¸âƒ£ What problem does $facet solve? (Very simple)

Imagine you have ONE list of data and you want MULTIPLE results from it.

Example:
From the same orders table, you want:

total orders

total sales amount

paid orders list

Normally â†’ 3 queries
With $facet â†’ 1 query

ğŸ‘‰ $facet = split one data flow into many result paths


Question:

From this SAME data, I want:

How many users total?

How many users are age 20?

$facet pipeline
db.users.aggregate([
  {
    $facet: {
      totalUsers: [
        { $count: "count" }
      ],
      age20Users: [
        { $match: { age: 20 } },
        { $count: "count" }
      ]
    }
  }
])

Result (IMPORTANT)
{
  totalUsers: [ { count: 3 } ],
  age20Users: [ { count: 2 } ]
}


ğŸ”´ Notice:

Same input data

Two different results

Returned together

5ï¸âƒ£ Why not do this without $facet?

Without $facet you must:

Query 1 â†’ total users
Query 2 â†’ age 20 users


With $facet:

Query 1 â†’ everything

6ï¸âƒ£ Very important rule (THIS causes confusion)
$facet does NOT filter data by itself

It only:

Splits the data

Each split must have its own $match, $group, $count, etc

7ï¸âƒ£ Visual diagram (clear mental model)
Input documents
   â”‚
   â–¼
 $facet
   â”œâ”€â”€ totalUsers pipeline
   â”‚       â””â”€â”€ count
   â”‚
   â””â”€â”€ age20Users pipeline
           â””â”€â”€ match age=20 â†’ count
---------------------------------------------------------------------------------
=>Unique City
4ï¸âƒ£ Why do we need $project after $group?

Because:

$group always puts the grouped value into _id

We usually donâ€™t want _id in the final output

We want a clean field name

So:

$group â†’ makes data unique

$project â†’ cleans and renames output

5ï¸âƒ£ Equivalent SQL (to make it crystal clear)
SELECT DISTINCT city FROM users;


MongoDB way:

$group â†’ DISTINCT
$project â†’ rename output


----------------------------------------------------------------------------------------------------------
ğŸ§  What is a Pipeline? (Very basic)
A pipeline is a sequence of steps.

Each step:

Takes data in

Does one job

Passes data to the next step

Data â†’ Step â†’ Step â†’ Step â†’ Final Result


In MongoDB:

Each step = pipeline stage

All steps together = aggregation pipeline

ğŸ§© What is a pipeline stage?

A pipeline stage is ONE STEP that changes or processes data.

Examples of stages:

$match â†’ filter

$group â†’ group

$project â†’ select / rename fields

$sort â†’ sort

$limit â†’ limit results


ğŸ“Œ MongoDB pipeline in real code
db.users.aggregate([
  { $match: { city: "Yangon" } },
  { $group: { _id: "$city" } },
  { $project: { _id: 0, city: "$_id" } }
])

Read this in plain English ğŸ‘‡

1ï¸âƒ£ $match
â¡ â€œKeep only users from Yangonâ€

2ï¸âƒ£ $group
â¡ â€œGroup them by city (remove duplicates)â€

3ï¸âƒ£ $project
â¡ â€œRename fields and clean outputâ€

ğŸ”‘ Important structure (THIS IS KEY)
aggregate([
  stage1,
  stage2,
  stage3
])


aggregate() â†’ runs pipeline

[ ] â†’ list of stages

{ } â†’ one stage